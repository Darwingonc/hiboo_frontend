<!-- dedication.component.html -->
<div *ngIf="loading" class="flex justify-center items-center min-h-screen">
  <p>Cargando dedicatoria...</p>
</div>

<div *ngIf="!loading && dedication" class="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-[#fff1eb] to-[#ace0f9] p-4">
  <div class="bg-white p-8 rounded-3xl max-w-md w-full shadow-lg text-center animate-fadeIn mb-8">
    <h1 class="text-2xl font-bold text-blue-700 mb-2">
      {{ dedication.status === 'completed' ? 'Un mensaje para ti 💐' : 'Dedicatoria lista 🎁' }}
    </h1>
    <p class="text-gray-700 font-light mb-4" *ngIf="dedication.status === 'completed' ? dedication.message : true">
      {{ dedication.status === 'completed'
      ? dedication.message
      : 'Graba tu voz, escribe tu dedicatoria o agrega tu canción favorita.' }}
    </p>

    <!-- Formulario -->
    <ng-container *ngIf="dedication.status === 'created'">
      <textarea [(ngModel)]="mensaje" placeholder="Escribe tu mensaje..." class="w-full p-2 mb-2 border rounded-xl outline-none"></textarea>
      <input [(ngModel)]="link" placeholder="Enlace de Spotify o YouTube" class="w-full p-2 mb-2 border rounded-xl outline-none" />
      <input [(ngModel)]="remitente" placeholder="Tu nombre (opcional)" class="w-full p-2 mb-2 border rounded-xl outline-none" />

      <!-- Botón de grabar / detener -->
      <div *ngIf="!audioURL">
        <button
          class="bg-gradient-to-r from-red-500 to-pink-500 text-white
           py-3 px-6 rounded-full mt-5 shadow-md
           hover:from-red-600 hover:to-pink-600
           active:scale-95 transition-all duration-200 flex items-center gap-2 mx-auto"
          (click)="toggleRecording()">

          <span *ngIf="!isRecording">🎙️ Empezar a grabar</span>
          <span *ngIf="isRecording">⏹️ Detener grabación</span>
        </button>
      </div>

      <!-- Animación mientras graba -->
      <div *ngIf="isRecording" class="mt-4 flex flex-col items-center">
        <div class="flex space-x-1">
          <div class="w-2 h-6 bg-red-500 animate-pulse"></div>
          <div class="w-2 h-8 bg-red-400 animate-ping"></div>
          <div class="w-2 h-10 bg-red-600 animate-pulse"></div>
          <div class="w-2 h-8 bg-red-400 animate-ping"></div>
          <div class="w-2 h-6 bg-red-500 animate-pulse"></div>
        </div>
        <p class="mt-2 text-sm text-gray-600">Grabando... {{recordingTime}}s</p>
      </div>

      <!-- Reproductor de audio -->
      <div *ngIf="audioURL && !isRecording" class="mt-6 bg-gray-50 p-4 rounded-xl shadow-inner w-full flex flex-col items-center">
        <audio [src]="audioURL" controls class="w-full rounded-lg"></audio>
        <button
          class="bg-gradient-to-r from-gray-500 to-gray-600 text-white
           px-5 py-2 rounded-full mt-3 shadow-sm
           hover:from-gray-600 hover:to-gray-700
           active:scale-95 transition-all duration-200 flex items-center gap-2"
          (click)="borrarAudio()">
          🗑️ Eliminar y volver a grabar
        </button>
      </div>




      <!--<div>
        <button class="bg-red-500 text-white py-2 px-4 rounded-full mt-5 mb-2 active:scale-95 transition-transform"
                (mousedown)="startRecording()" (mouseup)="stopRecording()">
          🎙️ Mantén presionado para grabar
        </button>
      </div>

      <div *ngIf="audioURL" class="mt-2">
        <audio [src]="audioURL" controls class="w-full"></audio>
        <button class="bg-gray-500 text-white px-4 py-1 rounded-full mt-2" (click)="borrarAudio()">Eliminar y volver a grabar</button>
      </div>-->

      <button class="bg-blue-700 text-white py-2 px-6 rounded-full mt-4" (click)="guardar()">Guardar dedicatoria</button>
    </ng-container>

    <!-- Vista completed -->
    <ng-container *ngIf="dedication.status === 'completed'">
      <div class="remitente mt-2 font-medium text-blue-700 italic">
        Atte: {{ dedication.sender_name || 'Anónimo' }}
      </div>

      <div *ngIf="dedication.audio_url" class="mt-4 mb-4">
        <audio [src]="dedication.audio_url" controls class="w-full"></audio>
      </div>

      <div [innerHTML]="dedication.media_url ? platformLinkHTML : ''" class="mt-2"></div>
    </ng-container>
  </div>

  <!-- Footer -->
  <footer class="text-center text-gray-700 text-sm" *ngIf="business">
    <!-- Logo + Nombre -->
    <div class="flex flex-col items-center mb-2">
      <img
        *ngIf="dedication.Business?.logo"
        [src]="dedication.Business.logo"
        alt="Logo de la empresa"
        class="h-32 -mt-8 -mb-8"
      />
      <div class="font-semibold text-base leading-none">{{ business.name }}</div>
    </div>

    <!-- Redes sociales -->
    <div class="flex justify-center mb-2 space-x-3">
      <a *ngIf="business.instagram_url" [href]="business.instagram_url" target="_blank">
        <img src="https://cdn-icons-png.flaticon.com/512/174/174855.png" width="28" alt="Instagram">
      </a>
      <a *ngIf="business.facebook_url" [href]="business.facebook_url" target="_blank">
        <img src="https://cdn-icons-png.flaticon.com/512/733/733547.png" width="28" alt="Facebook">
      </a>
      <a *ngIf="business.whatsapp_url" [href]="business.whatsapp_url" target="_blank">
        <img src="https://cdn-icons-png.flaticon.com/512/733/733585.png" width="28" alt="WhatsApp">
      </a>
      <a *ngIf="business.tiktok_url" [href]="business.tiktok_url" target="_blank">
        <img src="https://cdn-icons-png.flaticon.com/512/3046/3046121.png" width="28" alt="TikTok">
      </a>
    </div>

    <p>⏳ Esta dedicatoria estará disponible durante 7 días</p>
  </footer>
</div>
